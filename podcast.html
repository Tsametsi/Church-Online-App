<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Podcast Name</title>
    <link rel="stylesheet" href="podcast.css">
    <a href="javascript:history.back()" class="back-button">← Back</a>
</head>
<body>
    <header>
        <h1>Podcast</h1>
        <p>Explore a range of discussions</p>
    </header>

    <main>
        <section class="subscription">
            <h2>Manage Podcasts</h2>
            <div class="button-group">
                <button id="toggleUpload">Upload Your Podcast</button>
                <button id="toggleLink">Add Podcast Link</button>
                <button id="toggleGroups">Manage Groups</button>
            </div>

            <div id="uploadSection" class="upload-section" style="display: none;">
                <form id="uploadPodcast" enctype="multipart/form-data">
                    <input type="text" name="title" placeholder="Podcast Title" required>
                    <textarea name="description" placeholder="Description" required></textarea>
                    <input type="file" name="audio" accept="audio/*">
                    <input type="file" name="video" accept="video/*">
                    <button type="submit">Upload Podcast</button>
                </form>                
            </div>

            <div id="linkSection" class="upload-section" style="display: none;">
                <form id="addPodcastLink">
                    <input type="text" name="title" placeholder="Podcast Title" required>
                    <textarea name="description" placeholder="Description" required></textarea>
                    <input type="url" name="youtube_link" placeholder="YouTube Link" required>
                    <button type="submit">Add Podcast Link</button>
                </form>
            </div>

            <div id="groupSection" class="upload-section" style="display: none;">
                <h2>Create or Manage Groups</h2>
                <form id="groupForm">
                    <div>
                        <label for="groupName">Group Name:</label>
                        <input type="text" id="groupName" name="groupName" required>
                    </div>
                    <div id="episodeSelection">
                        <!-- Episodes will be dynamically populated here with checkboxes -->
                    </div>
                    <button type="submit">Create Group</button>
                </form>
            </div>
        </section>

        <section class="episode-list">
            <h2>Episodes</h2>
            <div class="grid-container" id="episodeGrid">
                <!-- Podcast episodes will be dynamically inserted here -->
            </div>
        </section>

        <section class="about">
            <h2>About the Podcast</h2>
            <p>A space where faith meets inspiration! Join us for uplifting conversations, biblical teachings, and heartfelt testimonies that deepen your connection with God and the church community. Each episode features engaging discussions on spiritual growth, practical faith applications, and the love of Christ in everyday life. Whether you’re seeking encouragement, wisdom, or fellowship, you’ll find a home here. Tune in and let’s journey together in faith!</p>
        </section>

        <section class="community">
            <p>Follow us on social media:</p>
            <a href="#">Facebook</a> | <a href="#">Twitter</a> | <a href="#">Instagram</a>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Your Podcast Name. All rights reserved.</p>
        <p><a href="mailto:Apostolic@TV.com">Contact Us</a></p>
    </footer>

    <script src="podcasts.js"></script>
    <script>
        // Fetch podcast episodes from the API
        async function fetchPodcasts() {
            const response = await fetch('/api/podcasts');
            const podcasts = await response.json();

            const episodeGrid = document.getElementById('episodeGrid');
            episodeGrid.innerHTML = ''; // Clear existing content

            podcasts.forEach(podcast => {
                // Populate episode list for display
                const episode = document.createElement('div');
                episode.classList.add('episode');
                episode.dataset.id = podcast.id; // Add dataset ID to identify the episode
                episode.innerHTML = `
                    <h3>${podcast.title}</h3>
                    <p>${podcast.description}</p>
                    ${podcast.youtube_link ? `<iframe width="560" height="315" src="${podcast.youtube_link.replace('watch?v=', 'embed/')}" allowfullscreen></iframe>` : ''}
                    ${podcast.video_url ? `<video width="320" height="240" controls>
                        <source src="${podcast.video_url}" type="video/mp4">
                        Your browser does not support the video element.
                    </video>` : ''}
                    <a href="${podcast.youtube_link}" target="_blank">Watch on YouTube</a>
                    <p>Likes: <span class="like-count" data-id="${podcast.id}">${podcast.like_count}</span></p>
                    <button class="like-button" onclick="likePodcast('${podcast.id}')">Like</button>
                    <button class="delete-button" onclick="deletePodcast('${podcast.id}')">Delete</button>
                `;
                episodeGrid.appendChild(episode);
            });
        }

        // Function to delete a podcast
        async function deletePodcast(id) {
            const response = await fetch(`/api/podcasts/${id}`, {
                method: 'DELETE',
            });
            const result = await response.json();
            if (result.success) {
                // Remove the podcast from the display
                const episodeElement = document.querySelector(`.episode[data-id="${id}"]`);
                if (episodeElement) {
                    episodeElement.remove();
                }
                alert('Podcast deleted successfully');
            } else {
                alert('Failed to delete podcast');
            }
        }

        // Function to like a podcast
        async function likePodcast(id) {
            const response = await fetch(`/api/podcasts/${id}/like`, {
                method: 'POST',
            });
            const result = await response.json();
            if (result.success) {
                alert('Podcast liked successfully');
                // Update like count on the UI
                const likeCountElement = document.querySelector(`.like-count[data-id="${id}"]`);
                if (likeCountElement) {
                    likeCountElement.textContent = result.new_like_count; // Update with the new like count
                }
            } else {
                alert('Failed to like podcast');
            }
        }

        // Call the fetch function when the page loads
        window.onload = fetchPodcasts;

        document.getElementById('uploadPodcast').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch('/api/podcasts/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            alert(result.message);
            fetchPodcasts(); // Refresh the podcast list
            e.target.reset(); // Reset the form
        };

        document.getElementById('addPodcastLink').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch('/api/podcasts/link', {
                method: 'POST',
                body: new URLSearchParams(formData) // Ensure it sends the correct body format
            });
            const result = await response.json();
            alert(result.message);
            fetchPodcasts(); // Refresh the podcast list
            e.target.reset(); // Reset the form
        };

        document.getElementById('groupForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const selectedEpisodes = [...document.querySelectorAll('input[name="episode"]:checked')].map(cb => cb.value);
            formData.append('episodes', JSON.stringify(selectedEpisodes));
            
            const response = await fetch('/api/groups', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            alert(result.message);
            fetchPodcasts(); // Refresh the podcast list
            e.target.reset(); // Reset the form
        };

        // Toggle upload section
        document.getElementById('toggleUpload').onclick = () => {
            const uploadSection = document.getElementById('uploadSection');
            uploadSection.style.display = uploadSection.style.display === 'none' ? 'block' : 'none';
            document.getElementById('linkSection').style.display = 'none'; // Hide link section if upload is shown
            document.getElementById('groupSection').style.display = 'none'; // Hide group section if upload is shown
        };

        // Toggle link section
        document.getElementById('toggleLink').onclick = () => {
            const linkSection = document.getElementById('linkSection');
            linkSection.style.display = linkSection.style.display === 'none' ? 'block' : 'none';
            document.getElementById('uploadSection').style.display = 'none'; // Hide upload section if link is shown
            document.getElementById('groupSection').style.display = 'none'; // Hide group section if link is shown
        };

        // Toggle group section
        document.getElementById('toggleGroups').onclick = () => {
            const groupSection = document.getElementById('groupSection');
            groupSection.style.display = groupSection.style.display === 'none' ? 'block' : 'none';
            document.getElementById('uploadSection').style.display = 'none'; // Hide upload section if groups are shown
            document.getElementById('linkSection').style.display = 'none'; // Hide link section if groups are shown
        };
    </script>
</body>
</html>
