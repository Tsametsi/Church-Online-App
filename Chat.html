<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link rel="stylesheet" href="Chat.css">
    <link rel="stylesheet" href="Username.css">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Chat</h1>
    <div id="username-display">
        <!-- Username will be inserted here -->
    </div>

    <div id="users">
        <h2>Users</h2>
        <input type="text" id="user-search" placeholder="Search users...">
        <ul id="user-list"></ul>
    </div>

    <a href="javascript:history.back()" class="back-button">←Back</a>
    
    <div>
        <div id="chat">
            <h2>Chat with <span id="chat-with">Select a user</span></h2>
            <div id="message-box"></div>
            <input type="file" id="attachment-input">
            <input type="text" id="message-input" placeholder="Type a message...">
            <button id="send-button">Send</button>
            <button id="emoji-button">😀</button>
            <div id="emoji-picker" style="display: none;"></div>
        </div>
    </div>

    <script>
        const userList = document.getElementById('user-list');
        const chatWith = document.getElementById('chat-with');
        const messageBox = document.getElementById('message-box');
        const attachmentInput = document.getElementById('attachment-input');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const userSearch = document.getElementById('user-search');

        let selectedUser = '';
        let blockedUsers = [];
        const socket = io();
        const yourUsername = localStorage.getItem('username');

        if (!yourUsername) {
            window.location.href = '/Login.html';
        }

        // Set username display
        document.getElementById('username-display').textContent = `Logged in as: ${yourUsername}`;

        function loadUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(users => {
                    userList.innerHTML = '';
                    users.forEach(user => {
                        if (user.username !== yourUsername) {
                            const li = document.createElement('li');
                            const icon = document.createElement('img');
                            icon.src = 'chat_icon.png';
                            icon.classList.add('user-icon');
                            li.appendChild(icon);

                            const name = document.createElement('span');
                            name.textContent = user.username;
                            li.appendChild(name);

                            if (user.logged_in) {
                                const greenDot = document.createElement('span');
                                greenDot.classList.add('online-indicator');
                                li.appendChild(greenDot);
                            }

                            const toggleBlockButton = document.createElement('button');
                            if (blockedUsers.includes(user.username)) {
                                toggleBlockButton.textContent = 'Unblock';
                                toggleBlockButton.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    unblockUser(user.username);
                                });
                            } else {
                                toggleBlockButton.textContent = 'Block';
                                toggleBlockButton.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    blockUser(user.username);
                                });
                            }
                            li.appendChild(toggleBlockButton);

                            li.addEventListener('click', () => selectUser(user.username));
                            userList.appendChild(li);
                        }
                    });
                });
        }

        function filterUsers() {
            const query = userSearch.value.toLowerCase();
            const users = userList.querySelectorAll('li');
            users.forEach(user => {
                const name = user.querySelector('span').textContent.toLowerCase();
                user.style.display = name.includes(query) ? '' : 'none';
            });
        }

        userSearch.addEventListener('input', filterUsers);

        function loadMessages(user) {
            fetch(`/api/chat/messages/${yourUsername}/${user}`)
                .then(response => response.json())
                .then(messages => {
                    messageBox.innerHTML = '';
                    messages.forEach(message => {
                        if (blockedUsers.includes(message.username)) return;

                        const messageContainer = document.createElement('div');
                        messageContainer.classList.add('message-container');

                        const p = document.createElement('p');
                        p.classList.add('message', message.username === yourUsername ? 'sender' : 'receiver');
                        p.textContent = `${message.username}: ${message.message}`;
                        p.dataset.id = message.id;

                        if (message.attachment) {
                            const link = document.createElement('a');
                            link.href = message.attachment;
                            link.textContent = 'Attachment';
                            p.appendChild(link);
                        }

                        messageContainer.appendChild(p);
                        messageBox.appendChild(messageContainer);
                    });
                    addDeleteIcons();
                    messageBox.scrollTop = messageBox.scrollHeight;
                });
        }

        function selectUser(user) {
            selectedUser = user;
            chatWith.textContent = user;
            loadMessages(user);
        }

        function sendMessage() {
            const message = messageInput.value;
            const attachment = attachmentInput.files[0];

            if (message.trim() === '' && !attachment) return;

            const formData = new FormData();
            formData.append('username', yourUsername);
            formData.append('recipient', selectedUser);
            formData.append('message', message);
            if (attachment) {
                formData.append('attachment', attachment);
            }

            fetch('/api/chat/send', {
                method: 'POST',
                body: formData
            }).then(() => {
                messageInput.value = '';
                attachmentInput.value = '';
                socket.emit('send_message', {
                    username: yourUsername,
                    recipient: selectedUser,
                    message: message,
                    attachment: attachment ? URL.createObjectURL(attachment) : null
                });
                messageBox.scrollTop = messageBox.scrollHeight;
            });
        }

        function deleteMessage(messageId) {
            fetch(`/api/chat/delete/${messageId}`, {
                method: 'DELETE'
            }).then(() => {
                loadMessages(selectedUser);
            });
        }

        function addDeleteIcons() {
            const messages = document.querySelectorAll('#message-box .message');
            messages.forEach(message => {
                const deleteIcon = document.createElement('span');
                deleteIcon.textContent = '🗑️';
                deleteIcon.classList.add('delete-icon');
                deleteIcon.addEventListener('click', () => {
                    if (confirm('Do you want to delete this message?')) {
                        const messageId = message.dataset.id;
                        deleteMessage(messageId);
                    }
                });
                message.appendChild(deleteIcon);
            });
        }

        function blockUser(username) {
            blockedUsers.push(username);
            loadUsers();
            alert(`${username} has been blocked.`);
        }

        function unblockUser(username) {
            blockedUsers = blockedUsers.filter(user => user !== username);
            loadUsers();
            alert(`${username} has been unblocked.`);
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        socket.on('new_message', (data) => {
            if (blockedUsers.includes(data.username)) return;

            if (data.username === selectedUser || data.recipient === selectedUser) {
                const p = document.createElement('p');
                p.classList.add('message', data.username === yourUsername ? 'sender' : 'receiver');
                p.textContent = `${data.username}: ${data.message}`;
                p.dataset.id = data.id;

                if (data.attachment) {
                    const link = document.createElement('a');
                    link.href = data.attachment;
                    link.textContent = 'Attachment';
                    p.appendChild(link);
                }

                const deleteIcon = document.createElement('span');
                deleteIcon.textContent = '🗑️';
                deleteIcon.classList.add('delete-icon');
                deleteIcon.addEventListener('click', () => {
                    if (confirm('Do you want to delete this message?')) {
                        deleteMessage(data.id);
                    }
                });
                p.appendChild(deleteIcon);

                messageBox.appendChild(p);
                messageBox.scrollTop = messageBox.scrollHeight;
            }
        });

        socket.emit('join', yourUsername);

        socket.on('user_status', (data) => {
            loadUsers();
        });

        loadUsers();

        setInterval(() => {
            if (selectedUser) {
                loadMessages(selectedUser);
            }
        }, 4000);

        const emojis = [
            '😀', '😁', '😂', '🤣', '😃', '😄', '😅', '😆', '😉', '😊',
            '😎', '😍', '😘', '😗', '😙', '😚', '☺️', '😋', '😛', '😜',
            '😝', '🤤', '😒', '😓', '😔', '😕', '😖', '😣', '😞', '😟',
            '😤', '😢', '😭', '😱', '😨', '😰', '😥', '😓', '🤔', '🤐',
            '🤨', '🤯', '😶', '😶‍🌫️', '😑', '😬', '🙄', '🤥', '🤫', '🤭',
            '🤗', '🤔', '🤩', '🥳', '🥺', '😳', '😵', '🤯', '😲', '😶',
            '😴', '🤤', '🤓', '😺', '😸', '😹', '😻', '😼', '😽', '🙀',
            '😿', '😾', '🙌', '👏', '🤝', '👍', '👎', '👊', '✊', '✌️',
            '🤘', '🤙', '👋', '🤚', '🖐', '🖖', '👂', '👸', '🤴', '👵',
            '🧓', '👶', '🧒', '👦', '👧', '👨', '👩', '🤡', '🦄', '💩',
            '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿', '😾', '🙌'
        ];

        emojis.forEach(emoji => {
            const button = document.createElement('button');
            button.textContent = emoji;
            button.addEventListener('click', () => {
                messageInput.value += emoji;
                emojiPicker.style.display = 'none';
            });
            emojiPicker.appendChild(button);
        });

        emojiButton.addEventListener('click', () => {
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
        });
    </script>
</body>
</html>
